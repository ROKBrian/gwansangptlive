<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI ì‹¤ì‹œê°„ ë²ˆì—­ê¸°</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #101010;
      font-family: 'Segoe UI', sans-serif;
      color: #f0f0f0;
    }

    header {
      padding: 20px;
      text-align: center;
      background: #1c1c1c;
      border-bottom: 1px solid #333;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
      color: #00ffe0;
    }

    .buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }

    button {
      background-color: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #333;
    }

    #output {
      max-width: 800px;
      margin: 30px auto 40px;
      padding: 0 20px;
    }

    .entry {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .entry:first-child {
      background: #222;
      border-color: #00ffd0;
      font-size: 1.4rem;
      font-weight: bold;
      color: #00ffd0;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ AI ì‹¤ì‹œê°„ ë²ˆì—­ê¸° (êµì‚¬ìš©)</h1>
  </header>

  <div class="buttons">
    <button onclick="startRecognition()">ë²ˆì—­ ì‹œì‘</button>
    <button onclick="clearFirebase()">ğŸ§¹ ë°ì´í„° ì´ˆê¸°í™”</button>
  </div>

  <div id="output"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDo2a59IDdOZC3guUzqZXX_XkCk9DzoyHo",
      authDomain: "gwansangptlive.firebaseapp.com",
      databaseURL: "https://gwansangptlive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gwansangptlive",
      storageBucket: "gwansangptlive.firebasestorage.app",
      messagingSenderId: "417073178420",
      appId: "1:417073178420:web:4ee059be2ff23784dce761"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const output = document.getElementById('output');

    // ìƒˆë¡œê³ ì¹¨ ì‹œ subtitle ì´ˆê¸°í™”
    window.addEventListener('load', () => {
      db.ref("subtitle").remove().then(() => {
        console.log("ğŸ“¦ subtitle ë…¸ë“œ ì´ˆê¸°í™” ì™„ë£Œ");
      });
    });

    function clearFirebase() {
      if (confirm("ìë§‰ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        db.ref("subtitle").remove().then(() => {
          alert("âœ… ë°ì´í„° ì‚­ì œ ì™„ë£Œ");
          // í™”ë©´ì˜ ìë§‰ë„ ì§€ìš°ê¸°
          output.innerHTML = ''; 
        });
      }
    }

    let recognition;
    let timeoutId;
    let interimTranscript = ''; // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì„ì‹œ ë°œí™”
    let recentTranscripts = []; // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ ìµœê·¼ ë°œí™” ê¸°ë¡

    // ë‘ ë°œí™”ê°€ ìœ ì‚¬í•œì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
    function isSimilar(a, b) {
      if (!a || !b) return false;
      const tA = a.toLowerCase().trim();
      const tB = b.toLowerCase().trim();
      // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ê±°ë‚˜ ì™„ì „íˆ ê°™ìœ¼ë©´ ìœ ì‚¬í•˜ë‹¤ê³  íŒë‹¨
      return tA.includes(tB) || tB.includes(tA) || tA === tB;
    }
    
    // ë°œí™”ë¥¼ ì²˜ë¦¬í•˜ê³  ì¤‘ë³µì„ ë°©ì§€í•˜ëŠ” í•¨ìˆ˜
    function processTranscript(transcript) {
        if (!transcript) return;

        // ë§ˆì¹¨í‘œë‚˜ ì‰¼í‘œ ë“±ì„ ì œê±°í•˜ê³  ê³µë°±ì„ ì •ë¦¬
        const cleanTranscript = transcript.trim().replace(/[.,!?]+$/, '');

        // ìµœê·¼ ê¸°ë¡ì— ìœ ì‚¬í•œ ë°œí™”ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì²˜ë¦¬
        if (cleanTranscript && !recentTranscripts.some(t => isSimilar(t, cleanTranscript))) {
            displayText(cleanTranscript);
            handleFinalTranscript(cleanTranscript);
            
            // ë°œí™” ê¸°ë¡ì— ì¶”ê°€í•˜ê³ , ë„ˆë¬´ ë§ì€ ê¸°ë¡ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì˜¤ë˜ëœ ê¸°ë¡ ì œê±°
            recentTranscripts.push(cleanTranscript);
            if (recentTranscripts.length > 20) recentTranscripts.shift();
        }
    }


    async function startRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.)');
        return;
      }

      // API Key ìš”ì²­ ë° ì €ì¥ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      const apiKey = new URLSearchParams(window.location.search).get('key') || prompt('OpenAI API Key ì…ë ¥:');
      if (!apiKey) return alert('API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.');
      window._gptApiKey = apiKey;
      
      // ê¸°ì¡´ ì¸ì‹ì´ ì‹¤í–‰ ì¤‘ì´ë¼ë©´ ì¤‘ì§€
      if (recognition) {
        recognition.stop();
      }

      recognition = new webkitSpeechRecognition();
      recognition.lang = 'ko-KR'; // í•œêµ­ì–´ ì„¤ì •
      recognition.continuous = true; // ê³„ì† ì¸ì‹
      recognition.interimResults = true; // ì„ì‹œ ê²°ê³¼ ì œê³µ

      recognition.onresult = handleRecognitionResult;
      recognition.onerror = (event) => {
        console.error("Speech Recognition Error:", event.error);
      };
      recognition.onend = () => {
        // ì¸ì‹ì´ ëë‚¬ì„ ë•Œ ë‹¤ì‹œ ì‹œì‘ (continuous ì„¤ì •ì´ ìˆì§€ë§Œ, ë¸Œë¼ìš°ì € ì •ì±…ìƒ ë©ˆì¶œ ìˆ˜ ìˆìŒ)
        console.log("Speech Recognition Ended. Restarting...");
        // recognition.start(); // ë¬´í•œ ì¬ì‹œì‘ì€ ë¶ˆì•ˆì •í•  ìˆ˜ ìˆì–´ ì¼ë‹¨ ì£¼ì„ ì²˜ë¦¬
      };
      
      try {
        recognition.start();
      } catch(e) {
        console.error("Recognition start failed:", e);
      }
    }

    function handleRecognitionResult(event) {
      clearTimeout(timeoutId); // ìƒˆ ê²°ê³¼ê°€ ë“¤ì–´ì˜¤ë©´ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
      interimTranscript = ''; // í˜„ì¬ ì„¸ì…˜ì˜ ì„ì‹œ ë°œí™” ì´ˆê¸°í™”

      for (let i = event.resultIndex; i < event.results.length; ++i) {
        const result = event.results[i];
        let transcript = result[0].transcript.trim();

        if (result.isFinal) {
          // 1. ìµœì¢… ë°œí™”ê°€ í™•ì •ëœ ê²½ìš° ë°”ë¡œ ì²˜ë¦¬
          processTranscript(transcript);
        } else {
          // 2. ì„ì‹œ ë°œí™”ê°€ ìˆëŠ” ê²½ìš° ì €ì¥
          interimTranscript = transcript;
        }
      }

      // ë°œí™”ê°€ ì™„ì „íˆ ëë‚¬ëŠ”ì§€ í™•ì¸í•˜ëŠ” íƒ€ì´ë¨¸ ì„¤ì • (800ms)
      // ìµœì¢… ë°œí™”ê°€ ì•„ë‹ˆë”ë¼ë„ 800ms ë™ì•ˆ ë§ì´ ì—†ìœ¼ë©´ í˜„ì¬ ì„ì‹œ ë°œí™”ë¥¼ ìµœì¢…ìœ¼ë¡œ ê°„ì£¼í•˜ê³  ì²˜ë¦¬
      if (interimTranscript) {
        timeoutId = setTimeout(() => {
          // 800ms í›„ì—ë„ ìƒˆë¡œìš´ ìŒì„± ì…ë ¥ì´ ì—†ì—ˆë‹¤ë©´, ì´ ì„ì‹œ ë°œí™”ë¥¼ ìµœì¢…ìœ¼ë¡œ ì²˜ë¦¬
          processTranscript(interimTranscript);
          interimTranscript = ''; // ì²˜ë¦¬í–ˆìœ¼ë‹ˆ ë¹„ì›€
        }, 800);
      }
    }

    // í™”ë©´ì— ë°œí™”ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function displayText(text) {
      const div = document.createElement('div');
      div.className = 'entry';
      div.textContent = text;
      
      // ì²« ë²ˆì§¸ í•­ëª©ì€ ìŠ¤íƒ€ì¼ì´ ë‹¤ë¥´ë¯€ë¡œ ì œê±°í•˜ê³  ìƒˆë¡œ ì¶”ê°€
      if (output.firstChild) {
         output.firstChild.className = 'entry';
      }

      // ê°€ì¥ ìµœê·¼ ë°œí™”ë¥¼ ì²« ë²ˆì§¸ í•­ëª©ìœ¼ë¡œ ì„¤ì •
      div.className = 'entry';
      output.prepend(div);
      
      // ê°€ì¥ ìœ„ì— ìˆëŠ” í•­ëª©ì„ ê°•ì¡°
      if (output.firstChild) {
        output.firstChild.className = 'entry entry-highlight'; // CSSì— ì—†ëŠ” í´ë˜ìŠ¤ì§€ë§Œ, ê¸°ì¡´ ë¡œì§ìƒ :first-childê°€ ì‘ë™í•˜ë¯€ë¡œ ê´œì°®ìŒ
      }
    }

    // ë²ˆì—­ ë° Firebaseì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
    async function handleFinalTranscript(transcript) {
      const apiKey = window._gptApiKey;
      
      // ë³‘ë ¬ë¡œ ë²ˆì—­ ìš”ì²­ (ì¤‘êµ­ì–´, ëŸ¬ì‹œì•„ì–´)
      const [chinese, russian] = await Promise.all([
        translateText(transcript, 'zh', apiKey),
        translateText(transcript, 'ru', apiKey)
      ]);

      // Firebaseì— ë°ì´í„° ì €ì¥
      db.ref('subtitle').push({
        korean: transcript,
        chinese,
        russian,
        timestamp: Date.now()
      });
    }

    // OpenAIë¥¼ ì´ìš©í•œ ë²ˆì—­ í•¨ìˆ˜
    async function translateText(text, langCode, apiKey) {
      try {
        const res = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [
              { role: "system", content: `Translate the following Korean sentence to ${langCode}. Only show the translated sentence and do not include any extra text, comments, or explanations.` },
              { role: "user", content: text }
            ],
            // ë‚®ì€ latencyë¥¼ ìœ„í•´ streamì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆì§€ë§Œ, í˜„ì¬ëŠ” ê¸°ë³¸ ìš”ì²­ìœ¼ë¡œ ìœ ì§€
            // max_tokens, temperature ë“±ì˜ ì„¤ì •ì„ í†µí•´ ë²ˆì—­ í’ˆì§ˆì„ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          })
        });

        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(`OpenAI API Error: ${res.status} - ${errorData.error.message}`);
        }
        
        const data = await res.json();
        return data.choices?.[0]?.message?.content?.trim() || 'ë²ˆì—­ ì‹¤íŒ¨';
      } catch (error) {
          console.error(`Error translating to ${langCode}:`, error);
          return `ë²ˆì—­ ì˜¤ë¥˜: ${error.message}`;
      }
    }
  </script>
</body>
</html>
